# 背  包系统完整学习

## 一、创建枚举类型定义一些基本的属性

* ```c#
  public enum ItemType//表示物品的类型
  {
      AttackWeapon,
      Armor,//铠甲
      Shoe,//鞋子
      Necklace//项链
  }
  
  public enum SlotType//物品数据栏的类型
  {
      Bag, Box, Shop
  }
  
  public enum InventoryLocation
  {
      Player, Box
  }
  
  
  
  
  ```

* 





## 二、创建一个脚本专门储存物品信息的类以及一些结构体实现对数据的统一管理

* ```c#
  
  using UnityEngine;
  [System.Serializable]//使得创建的类都能被unity识别
  
  public class ItemDetails//物品的详细信息
  {
      public int itemID;
  
      public string itemName;
  
      public ItemType itemType;
  
      public Sprite itemIcon;//在背包中的图标
  
      public Sprite itemOnWorldSprite;//物品在世界地图上的图片
  
      public string itemDescription;//物品的描述
  
      public int itemRadius;//表示物品在网格地图中可以使用的范围
  
      //可以创建bool值表示物品的状态
  
      public bool canPickUp;
      public int itemPrice;//物品的价值
  
      [Range(0, 1)]//设置范围
      public float sellPercentage;//出售时价格占购买价格的百分比
  }
  
  [System.Serializable]//序列化，使得能被unity识别
  //创建背包
  public struct InventoryItem
  {
      public int itemID;
  
      public int itemAmount;//物品的数目
  
  
  }
  ```



## 三、创建一个脚本编写一个scriptobject用来储存物品数据

* ```c#
  using System.Collections;
  using System.Collections.Generic;
  using UnityEngine;
  
  [CreateAssetMenu(fileName = "ItemDataList_So", menuName = "Inventory/ItemDataList_So")]//设置菜单的位置
  public class ItemDataList_So : ScriptableObject//创建数据库
  {
      public List<ItemDetails> itemDetailsList;
  }
  
  ```

* 写好脚本后在一个文件夹中创建写好的scriptobject

* 创建的路径为你代码中所写的路径![image-20230615160102527](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615160102527.png)

* 创建好后可以点击加号创建一个物品数据，一下是我创建的物品数据
* ![image-20230615160215051](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615160215051.png)



## 四、专门创建一个文件储存背包逻辑的脚本



* 首先要创建一个单例模式的类

* ```c#
  
  using UnityEngine;
  
  
  //单例模式
  public class Singleton<T> : MonoBehaviour where T : Singleton<T>
  {
      private static T instance;
  
      public static T Instance
      {
          get => instance;
      }
  
      protected virtual void Awake()
      {
          if (instance != null)//必须满足唯一性的原则
              Destroy(gameObject);
          else
              instance = (T)this;
      }
  
      protected virtual void OnDestroy()
      {
          if (instance == this)
              instance = null;
      }
  }
  
  ```

* 

* 创建一个管理物品的脚本(InventoryManager)挂载在一个空物体（InventoryManager）上放在固定的场景中

* ```c#
  using System.Collections;
  using System.Collections.Generic;
  using UnityEngine;
  
  namespace Gameobject.Inventory  //添加一个命名空间,只有使用了该命名空间才能调用其中的内容，将所有与背包相关的脚本都使用该命名空间
  {
      //管理数据
      public class InventoryManager : Singleton<InventoryManager>//继承至单例模式
      {
          [Header("物品数据")]
          #region 物品数据
          public ItemDataList_So itemDataList_So;
          #endregion
  
          [Header("背包数据")]
          public InventoryBag_So playerBag;
          
          
          private void Start()
          {
              EventHandler.CallUpdateInventoryUI(InventoryLocation.Player, playerBag.itemList);
          }
          public ItemDetails GetItemDetails(int ID)//根据ID查找对应的ItemDetails
          {
              return itemDataList_So.itemDetailsList.Find(i => i.itemID == ID);//通过itemDataList_So脚本中的itemDetailsList根据ID查找对应的itemdetails
          }
  
  
          /// <summary>
          /// 拾取地上的物品放进背包
          /// </summary>
          /// <param name="item_">对象的信息</param>
          /// <param name="toDestory">是否要销毁</param>
          public void AddItem(Item item, bool toDestory)
          {
  
              var index = GetItemIndexInBag(item.itemID);//如果物品存在获取序号
  
              AddItemIndex(item.itemID, index, 1);//根据序号添加物品
  
              if (toDestory)
              {
                  Destroy(item.gameObject);
              }
  
              //更新UI，通过事件喊话的方式更新UI
              EventHandler.CallUpdateInventoryUI(InventoryLocation.Player, playerBag.itemList);
  
          }
          /// <summary>
          /// 检查背包中是否已经有该物品
          /// </summary>
          /// <param name="ID"></param>
          /// <returns></returns>
          private int GetItemIndexInBag(int ID)
          {
              for (int i = 0; i < playerBag.itemList.Count; i++)
              {
                  if (playerBag.itemList[i].itemID == ID)
                      return i;
              }
              return -1;
          }
  
          /// <summary>
          /// 检查背包是否有空位
          /// </summary>
          /// <returns></returns>
          private bool CheckBagCapacity()//判断背包是否有空位
          {
              for (int i = 0; i < playerBag.itemList.Count; i++)//如果数量为0就表示该位置是空的
              {
                  if (playerBag.itemList[i].itemID == 0)
                      return true;
              }
              return false;
          }
  
          /// <summary>
          /// 在背包序号位置添加物品
          /// </summary>
          /// <param name="ID"></param>
          /// <param name="index"></param>
          /// <param name="amount"></param>
          private void AddItemIndex(int ID, int index, int amount)
          {
              if (index == -1 && CheckBagCapacity())//背包中没有这个物品，需要添加进去，同时有空位
              {
                  var item = new InventoryItem { itemID = ID, itemAmount = amount };
                  for (int i = 0; i < playerBag.itemList.Count; i++)
                  {
                      if (playerBag.itemList[i].itemID == 0)
                      {
                          playerBag.itemList[i] = item;
                          break;
                      }
                  }
              }
              else//背包中有该物品直接更改该物品的数目
              {
  
                  int currentAmount = playerBag.itemList[index].itemAmount + amount;
                  var item = new InventoryItem { itemID = ID, itemAmount = currentAmount };
                  playerBag.itemList[index] = item;
              }
          }
  
          /// <summary>
          /// player背包的范围内交换物品
          /// </summary>
          /// <param name="fromIndex"></param>
          /// <param name="targetIndex"></param>
          public void SwapItem(int fromIndex, int targetIndex)
          {
              InventoryItem currentItem = playerBag.itemList[fromIndex];
              InventoryItem targetItem = playerBag.itemList[targetIndex];
  
              if (targetItem.itemID != 0)
              {
                  playerBag.itemList[fromIndex] = targetItem;
                  playerBag.itemList[targetIndex] = currentItem;
              }
              else
              {
                  playerBag.itemList[targetIndex] = currentItem;
                  playerBag.itemList[fromIndex] = new InventoryItem();
              }
  
              EventHandler.CallUpdateInventoryUI(InventoryLocation.Player, playerBag.itemList);
          }
      }
  }
  
  
  ```

* 

## 五、创建一个空的物体(ItemBase)作为一个基本的物品，让该物品可以通过代码实现根据物品id将空物体变成对应的物品

* 该基本物品需要一个碰撞体，以及为其添加一个子物体，子物体上添加spriterenderer组件，sprite sort point 改为pivot

* ![image-20230615162238144](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615162238144.png)

  

* 创建一个item脚本用来实现将基本物品转化为目标物品的功能,将其挂载到ItemBase上面，并将ItemBase 这个物品作为预制体

* ```c#
  using System.Collections;
  using System.Collections.Generic;
  using UnityEngine;
  
  using Gameobject.Inventory;//使用inventory的命名空间                        
  public class item : MonoBehaviour
  {
      public int itemID;
  
      private SpriteRenderer spriteRenderer;//通过SpriteRenderer组件为itemBase添加图片
  
      public ItemDetails itemDetails;//物品的详细信息
  
      private BoxCollider2D coll;
  
      private void Awake()
      {
          spriteRenderer = GetComponentInChildren<SpriteRenderer>();//获得itemBase子物体的SpriteRenderer
          coll = GetComponent<BoxCollider2D>();
      }
  
      private void Start()
      {
          if (itemID != 0)
          {
              Init(itemID);
          }
      }
      public void Init(int ID)//加载对应的物体
      {
          itemID = ID;
          //为itemdetails赋值
          itemDetails = InventoryManager.Instance.GetItemDetails(itemID);
  
          if (itemDetails != null)//itemDetails得到的是一个类，需要判断是不是为空
          {
              spriteRenderer.sprite = itemDetails.itemOnWorldSprite != null ? itemDetails.itemOnWorldSprite : itemDetails.itemIcon;
  
              //修改碰撞体的尺寸，图片的锚点设置为底部能产生叠层的效果，但会导致碰撞体与图片错位
              Vector2 newSize = new Vector2(spriteRenderer.sprite.bounds.size.x, spriteRenderer.sprite.bounds.size.y);//获取图片的尺寸
              coll.size = newSize;
              coll.offset = new Vector2(0, spriteRenderer.sprite.bounds.center.y);//设置偏移量，通过center获取图片的中心
          }
      }
  }
  
  ```



## 六、实现拾取物品

* 专门写一个脚本（ItemPickUp）挂载到player上面实现拾取物品的功能，通过碰撞实现

* 改代码也与背包有关，添加进背包的命名空间

* ```c#
  using System.Collections;
  using System.Collections.Generic;
  using UnityEngine;
  
  
  namespace Gameobject.Inventory//写在inventory的命名空间中
  {
      public class ItemPickUp : MonoBehaviour
      {
          private void OnTriggerEnter2D(Collider2D other)
          {
  
              Item item = other.GetComponent<item>();
  
              if (item != null)
              {
  
                  if (item.itemDetails.canPickUp)
                  {
                      InventoryManager.Instance.AddItem(item, true);//拾取物品
                  }
              }
          }
      }
  }
  
  
  ```

## 七、创建角色的背包

* 背包只需储存物品的id和数量，在数据库DataCollection中创建一个结构体表示背包中需要储存的数据有哪些

* 背包也需要创建一个scriptobject，也归InventoryManager管理

* ```c#
  using System.Collections;
  using System.Collections.Generic;
  using UnityEngine;
  
  
  //创建scriptobject文件
  [CreateAssetMenu(fileName = "InventoryBag_So", menuName = "Inventory/InventoryBag_So")]
  public class InventoryBag_So : ScriptableObject
  {
      public List<InventoryItem> itemList;
  }
  
  ```

* 根据你脚本中的路径创建

* ![image-20230615170455179](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615170455179.png)

## 八、创建背包的UI

* 为UI单独创建一个场景，该场景也是固定不动的
* 更改图片的类型为可拉伸的
* ![image-20230615172859823](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615172859823.png)

* 可以选中图片点击sprite editor对图片拉伸的部位进行设置，绿色边框框住的部分为拉伸的部分
* ![image-20230615173105034](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615173105034.png)

* 将UI的大小位置设置为不超过其父物体
* 按住alt + shift点击右下角
* ![image-20230615173423381](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615173423381.png)

* 可以调整UI与周围的间距
* ![image-20230615173634490](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615173634490.png)

* 快速管理大量的UI，使其按横向一定顺序排列，可以在UI的父物体上添加Horizontal Layout Group,使其按一定顺序排列可以添加Grid Layout Group
* 如果UI也在上面的父物体下但是不想被按顺序排列可以添加Layout Element
* ![image-20230615184151949](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615184151949.png)

* button组件可以通过键盘控制切换，如果不想的话需要调整Navigation为none
* ![image-20230615185223825](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615185223825.png)
* ![image-20230615190815945](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615190815945.png)

* 通过脚本将背包中物品的数据和UI联系起来，挂载到每个格子上面

* ![image-20230615193922097](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615193922097.png)

* ```c#
  using System.Collections;
  using System.Collections.Generic;
  using UnityEngine;
  using UnityEngine.UI;//使用UI的命名空间
  using TMPro;//文字使用的TextMashpro
  using UnityEngine.EventSystems;//使用事件的 命名空间
  
  namespace Gameobject.Inventory
  {
      public class SlotUI : MonoBehaviour, IPointerClickHandler, IBeginDragHandler, IDragHandler, IEndDragHandler//向物品栏中添加数据，使用点击的事件接口,开始拖拽，拖拽过程，停止拖拽过程，点按事件让vs自动补全函数
      {
          [Header("组件获取")]
          //在inspector窗口中获取组件是最快的
          [SerializeField] private Image slotImage;//显示的图片
          [SerializeField] private TextMeshProUGUI amountText;//数量
          [SerializeField] public Image slotHightlight;//被点击时的图像
          [SerializeField] private Button button;//按钮
  
          [Header("格子的类型")]
          public SlotType slotType;
  
          public bool isSelected;//判断是否被选中
  
          public int slotIndex;//格子的序号
          //物品信息
          public ItemDetails itemDetails;
          public int itemAmount;
  
  
          private InventoryUI inventoryUI => GetComponentInParent<InventoryUI>();//从父级处获得InventoryUI的组件
          /// <summary>
          /// 更新格子的信息
          /// </summary>
          /// <param name="item"></param>
          /// <param name="amount">物品的数量</param>
          public void UppdateSlot(ItemDetails item, int amount)
          {
              itemDetails = item;
              slotImage.sprite = item.itemIcon;
              itemAmount = amount;
              amountText.text = amount.ToString();
              slotImage.enabled = true;
              button.interactable = true;
          }
  
          private void Start()
          {
              isSelected = false;
              if (itemDetails.itemID == 0)
              {
                  UpdateEmptySlot();
              }
          }
          /// <summary>
          /// 更新格子为空
          /// </summary>
          public void UpdateEmptySlot()
          {
              if (isSelected)
                  isSelected = false;
              slotImage.enabled = false;
              amountText.text = string.Empty;
              button.interactable = false;
          }
  
          public void OnPointerClick(PointerEventData eventData)//点击的事件
          {
              if (itemAmount == 0) return;
              isSelected = !isSelected;
  
              inventoryUI.UpdateSlotHightlight(slotIndex);
          }
  
          public void OnBeginDrag(PointerEventData eventData)//开始拖拽时
          {
              if (itemAmount != 0)
              {
                  inventoryUI.dragImage.enabled = true;
                  inventoryUI.dragImage.sprite = slotImage.sprite;
                  inventoryUI.dragImage.SetNativeSize();//将图片设置为本来的大小防止拖拽是图片变形
  
                  isSelected = true;
                  inventoryUI.UpdateSlotHightlight(slotIndex);
              }
          }
  
          public void OnDrag(PointerEventData eventData)
          {
              inventoryUI.dragImage.transform.position = Input.mousePosition;//拖拽的过程中让图片的位置始终等于鼠标的位置
          }
  
          public void OnEndDrag(PointerEventData eventData)
          {
              inventoryUI.dragImage.enabled = false;
              //Debug.Log(eventData.pointerCurrentRaycast.gameObject);
  
              if (eventData.pointerCurrentRaycast.gameObject != null)//表示指针射线触碰的物体不为空
              {
                  if (eventData.pointerCurrentRaycast.gameObject.GetComponent<SlotUI>() == null)
                      return;
                  var targetSlot = eventData.pointerCurrentRaycast.gameObject.GetComponent<SlotUI>();
                  int targetIndex = targetSlot.slotIndex;
  
                  //在player自身的范围内交换就行
                  if (slotType == SlotType.Bag && targetSlot.slotType == SlotType.Bag)
                  {
                      InventoryManager.Instance.SwapItem(slotIndex, targetIndex);
                  }
  
                  //清空高亮的显示
                  inventoryUI.UpdateSlotHightlight(-1);
              }
              //扔到地上
              else
              {
                  //鼠标对应的地面的坐标
                  var pos = Camera.main.ScreenToWorldPoint(new Vector3(Input.mousePosition.x, Input.mousePosition.y, -Camera.main.transform.position.z));
                  EventHandler.CallInstantiateItemScene(itemDetails.itemID, pos);
              }
          }
      }
  }
  
  
  ```

* 拖拽事件，为拖拽的ui单独创建一个canvas ，拖拽的图片由InventoryUI控制

* ![image-20230615195722499](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615195722499.png)

* ![image-20230615194957587](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615194957587.png)

* canvasScaler直接移除![image-20230615195142566](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615195142566.png)

* 因为Slot_Bag这个UI上有一些子物体会遮挡鼠标的射线，需要将他们遮挡射线全部取消勾选

* text的UI的取消勾选在extra setting中![image-20230615200457775](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615200457775.png)

* 创建一个脚本（InventoryUI）专门管理UI的逻辑,挂载到UI的总父级上面

* ```c#
  using System.Collections;
  using System.Collections.Generic;
  using UnityEngine;
  using UnityEngine.UI;
  namespace Gameobject.Inventory//背包系统的命名空间
  {
  
  
      public class InventoryUI : MonoBehaviour
      {
  
          [Header("拖拽")]
          public Image dragImage;
  
          [Header("玩家背包")]
          [SerializeField] private GameObject Bag;//背包
  
          [SerializeField] private SlotUI[] playerSlots;//物品格
  
          /// <summary>
          /// 注册更新UI的事件的方法
          /// </summary>
          private void OnEnable()
          {
              EventHandler.UpdateInventoryUI += OnUpdateInventoryUI;
          }
  
          private void OnDisable()
          {
              EventHandler.UpdateInventoryUI -= OnUpdateInventoryUI;
          }
  
  
  
          private void Start()
          {
              //给每个格子一个序号
              for (int i = 0; i < playerSlots.Length; i++)
              {
                  playerSlots[i].slotIndex = i;
              }
          }
  
          private void Update()
          {
              if (Input.GetKeyDown(KeyCode.B))
              {
                  if (Bag.activeSelf)
                      Bag.SetActive(false);
                  else
                      Bag.SetActive(true);
              }
          }
          private void OnUpdateInventoryUI(InventoryLocation location, List<InventoryItem> list)//更新UI事件
          {
              switch (location)
              {
                  case InventoryLocation.Player:
                      for (int i = 0; i < playerSlots.Length; i++)
                      {
                          if (list[i].itemAmount > 0)
                          {
                              var item = InventoryManager.Instance.GetItemDetails(list[i].itemID);
                              playerSlots[i].UppdateSlot(item, list[i].itemAmount);
                          }
                          else
                          {
                              playerSlots[i].UpdateEmptySlot();
                          }
                      }
                      break;
              }
          }
  
  
          /// <summary>
          /// 更新高亮显示
          /// </summary>
          /// <param name="index"></param>
          public void UpdateSlotHightlight(int index)//打开高亮的图标
          {
              foreach (var slot in playerSlots)
              {
                  if (slot.slotIndex == index && slot.isSelected)
                  {
                      slot.slotHightlight.gameObject.SetActive(true);
                  }
                  else
                  {
                      slot.isSelected = false;
                      slot.slotHightlight.gameObject.SetActive(false);
                  }
              }
          }
      }
  }
  
  
  ```

* 

* 通过事件的方式更新UI

* 创建一个脚本管理所有的事件

* ```c#
  using System.Collections;
  using System.Collections.Generic;
  using UnityEngine;
  using System;//使用event和Action需要的头文件
  //事件中心脚本
  public static class EventHandler
  {
      public static event Action<InventoryLocation, List<InventoryItem>> UpdateInventoryUI;//注册事件,<>中表示参数
  
      public static void CallUpdateInventoryUI(InventoryLocation location, List<InventoryItem> list)
      {
          UpdateInventoryUI?.Invoke(location, list);//加载事件
      }
  
  
      //注册一个在地面上生成物品的事件
      public static event Action<int, Vector3> InstantiateItemInScene;
      public static void CallInstantiateItemScene(int ID, Vector3 pos)
      {
          InstantiateItemInScene?.Invoke(ID, pos);
      }
  }
  
  ```

* 在InventoryUI中注册事件，并让VS自动生成函数方法，只需更改变量的名字

* ![image-20230615192555411](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615192555411.png)

* 直接通过喊话的方式更新UI![image-20230615192707310](https://raw.githubusercontent.com/LuoYangSunTian/Image/main/Img/image-20230615192707310.png)

* activeInHierarchy可以判断一个对象是否是active的状态
